name: Deploy Documentation

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Install dependencies
        run: |
          pip install mkdocs-material
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Prepare Documentation
        run: |
          # 1. Prepare Landing Page (README -> index.md)
          # We use the repository README as the documentation homepage.
          cp README.md docs/index.md
          
          # 2. Setup Assets
          # Copy general assets (logos, badges) to the docs folder for local referencing
          cp -r assets docs/
          
          # 3. Path & Layout Adjustments
          # Fix image paths: Replace absolute GitHub URLs with local relative paths Use local assets
          sed -i 's|src="https://raw.githubusercontent.com/lerdmann1601/HERA-Matlab/main/assets/|src="assets/|g' docs/index.md
          
          # Fix Alignment: Enable Markdown parsing inside the centering div for the logo/header
          sed -i 's|<div align="center">|<div align="center" markdown="1">|g' docs/index.md

          # 4. Standardize Alerts
          # Convert GitHub-style alerts (> [!WARNING]) to MkDocs Material Admonitions (!!! warning)
          sed -i 's|> \[!WARNING\]|!!! warning|g' docs/*.md
          sed -i 's|> \[!NOTE\]|!!! note|g' docs/*.md
          sed -i 's|> \[!IMPORTANT\]|!!! tip|g' docs/*.md

          # 5. Integrate Theoretical Background (Paper)
          # Prepare images for the methodology section
          mkdir -p docs/images
          cp -r paper/images/* docs/images/ 2>/dev/null || true

          # Create a temporary copy of the paper to clean up attributes that break MkDocs
          cp paper/paper.md paper/paper_clean.md
          
          # Remove Pandoc image attributes (e.g., {height=85%}) to force standard Markdown output
          # We use a robust regex to catch {height=...} with optional spaces
          sed -i -E 's/\{[[:space:]]*height=[^}]*\}[[:space:]]*//g' paper/paper_clean.md

          # Enable link-citations in the YAML metadata
          sed -i 's/bibliography: paper.bib/bibliography: paper.bib\nlink-citations: true/' paper/paper_clean.md
          

          # Convert Paper to Documentation Page
          # Uses Pandoc to:
          # - Resolve citations from paper.bib ([@Auth2025] -> (Auth, 2025))
          # - Append bibliography
          # - Convert to HTML (safer for complex DOIs and styling)
          # - Use APA style to enforce inclusion of DOIs/URLs
          pandoc paper/paper_clean.md \
            -o docs/Methodology.md \
            --from markdown --to html \
            --citeproc \
            --csl https://www.zotero.org/styles/apa \
            --bibliography paper/paper.bib

          # Image Paths in generated HTML
          sed -i 's|src="images/|src="../images/|g' docs/Methodology.md


      - name: Deploy to GitHub Pages
        run: mkdocs gh-deploy --force
